<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ì–æ–ª–æ—Å–æ–≤–æ–π –¢—Ä–µ–∫–µ—Ä –†–∞—Å—Ö–æ–¥–æ–≤</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
    }
    button {
      font-size: 1.2rem;
      padding: 0.7rem 1.5rem;
      cursor: pointer;
    }
    .result, .parsed, .error {
      margin-top: 1rem;
      padding: 0.5rem;
      border-radius: 4px;
    }
    .result { background: #e0f7fa; }
    .parsed { background: #e8f5e9; }
    .error { background: #ffebee; color: #c62828; }
  </style>
</head>
<body>
  <h2>üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤–æ–π –¢—Ä–µ–∫–µ—Ä –†–∞—Å—Ö–æ–¥–æ–≤</h2>
  <button id="start">üé§ –ì–æ–≤–æ—Ä–∏—Ç—å</button>
  <div class="result" id="transcript"></div>
  <div class="parsed" id="parsed"></div>
  <div class="error" id="error"></div>

  <script>
    const button = document.getElementById('start');
    const transcriptDiv = document.getElementById('transcript');
    const parsedDiv = document.getElementById('parsed');
    const errorDiv = document.getElementById('error');

    const endpoint = 'https://script.google.com/macros/s/AKfycbwZ8H7v5IFTlMHsCWWl4aGfld4RyPVC54IB9FEp4x5odw4XWEoiqPe6r1TmXVVLfjPZog/exec';

    function parseText(text) {
      const cleanText = text.toLowerCase().replace(/[,]/g, '');
      const regex = /(\b—Ä–∞—Å—Ö–æ–¥|\b–¥–æ—Ö–æ–¥)\s+(\w+)\s+(\d+)\s*(–µ–≤—Ä–æ)?\s*(.*)/i;
      const match = cleanText.match(regex);
      if (!match) return null;

      return {
        type: match[1],
        category: match[2],
        amount: parseFloat(match[3]),
        comment: match[5] || '',
      };
    }

    function sendData(data) {
      fetch(endpoint, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'application/json',
        },
      })
      .then(res => res.json())
      .then(json => {
        parsedDiv.innerHTML += `<br/>‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${JSON.stringify(json)}`;
      })
      .catch(err => {
        errorDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + err;
      });
    }

    button.onclick = () => {
      errorDiv.textContent = '';
      parsedDiv.textContent = '';
      transcriptDiv.textContent = 'üé§ –°–ª—É—à–∞—é...';

      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'ru-RU';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onresult = event => {
        const text = event.results[0][0].transcript;
        transcriptDiv.textContent = `‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ${text}`;
        const data = parseText(text);

        if (data) {
          parsedDiv.innerHTML = `üìå –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ:<br/>
            –¢–∏–ø: ${data.type}<br/>
            –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${data.category}<br/>
            –°—É–º–º–∞: ${data.amount}<br/>
            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${data.comment}`;
          sendData(data);
        } else {
          errorDiv.textContent = '‚ö†Ô∏è –§–æ—Ä–º–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: "–¢–∏–ø, –∫–∞—Ç–µ–≥–æ—Ä–∏—è, —Å—É–º–º–∞ –µ–≤—Ä–æ, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"';
        }
      };

      recognition.onerror = event => {
        errorDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ${event.error}`;
      };

      recognition.start();
    };
  </script>
</body>
</html>
